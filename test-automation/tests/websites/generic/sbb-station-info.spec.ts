import { test, expect } from '@playwright/test';
import { createObservableActions } from '../../../test-helpers/observability';

test.describe('SBB.ch Station Information Testing', () => {
  
  test('Test station facilities and service information', async ({ page }) => {
    const actions = createObservableActions(page);
    
    actions.logTestInfo('üöâ Testing station information and facilities');
    
    await actions.step('üè† Navigate to SBB Homepage', async () => {
      await actions.observableGoto('https://www.sbb.ch', 'Navigate to SBB homepage');
      
      // Accept cookies
      try {
        await page.waitForSelector('#onetrust-accept-btn-handler', { timeout: 3000 });
        await page.click('#onetrust-accept-btn-handler');
        actions.logTestInfo('Accept cookies');
      } catch (error) {
        actions.logTestInfo('‚ÑπÔ∏è No cookie banner');
      }
    });

    await actions.step('üîç Look for Station Information Section', async () => {
      // Look for station information in navigation
      const stationInfoSelectors = [
        'a:has-text("Bahnhof")',
        'a:has-text("Station")',
        'a:has-text("Bahnh√∂fe")',
        'a:has-text("Stations")',
        'a:has-text("Services")',
        'a:has-text("Dienstleistungen")',
        '[href*="station"]',
        '[href*="bahnhof"]',
        '.station-info',
        '.services'
      ];
      
      let stationInfoFound = false;
      
      for (const selector of stationInfoSelectors) {
        const stationLink = page.locator(selector).first();
        const isVisible = await stationLink.isVisible().catch(() => false);
        
        if (isVisible) {
          const linkText = await stationLink.textContent();
          actions.logTestInfo(`üöâ Found station info link: "${linkText}"`);
          await stationLink.click();
          stationInfoFound = true;
          await page.waitForLoadState('networkidle');
          break;
        }
      }
      
      if (!stationInfoFound) {
        actions.logTestInfo('‚ÑπÔ∏è Station info not in main navigation, searching stations');
      }
    });

    await actions.step('üöâ Search for Major Station Information', async () => {
      // Search for a major station (Z√ºrich HB) to get detailed information
      const searchSelectors = [
        'input[placeholder*="Station"]',
        'input[placeholder*="Bahnhof"]',
        'input[name*="station"]',
        'input[name*="search"]',
        '.search-input',
        '[data-testid*="search"]'
      ];
      
      let searchFound = false;
      
      for (const selector of searchSelectors) {
        const searchInput = page.locator(selector).first();
        const isVisible = await searchInput.isVisible().catch(() => false);
        
        if (isVisible) {
          await searchInput.fill('Z√ºrich HB');
          actions.logTestInfo('üîç Searching for Z√ºrich HB station info');
          
          // Wait for autocomplete
          await page.waitForTimeout(1000);
          
          // Look for suggestion
          const suggestion = page.locator('text="Z√ºrich HB"').first();
          const hasSuggestion = await suggestion.isVisible().catch(() => false);
          
          if (hasSuggestion) {
            await suggestion.click();
            actions.logTestInfo('‚úÖ Selected Z√ºrich HB from suggestions');
          } else {
            await page.keyboard.press('Enter');
          }
          
          searchFound = true;
          await page.waitForLoadState('networkidle');
          break;
        }
      }
      
      if (!searchFound) {
        // Try direct navigation to station page
        await page.goto('https://www.sbb.ch/de/bahnhof-services.html');
        actions.logTestInfo('üöâ Navigating directly to station services');
        await page.waitForLoadState('networkidle');
      }
    });

    await actions.step('üè¢ Analyze Station Facilities Information', async () => {
      // Look for station facilities and services
      const facilitiesInfo = await page.evaluate(() => {
        const results = {
          facilitiesFound: [] as string[],
          servicesFound: [] as string[],
          accessibilityInfo: false,
          shoppingOptions: false,
          parkingInfo: false,
          wifiInfo: false,
          facilityCounts: {} as Record<string, number>
        };
        
        // Common station facilities
        const facilityKeywords = [
          'WC', 'Toilet', 'Restaurant', 'Caf√©', 'Shop', 'Gesch√§ft',
          'Parkplatz', 'Parking', 'Information', 'Schalter', 'Counter',
          'Geldautomat', 'ATM', 'Aufzug', 'Elevator', 'Rolltreppe', 'Escalator',
          'Billettautomat', 'Ticket machine', 'Warteraum', 'Waiting room'
        ];
        
        facilityKeywords.forEach(keyword => {
          if (document.body.textContent?.includes(keyword)) {
            results.facilitiesFound.push(keyword);
          }
        });
        
        // Services
        const serviceKeywords = [
          'Gep√§ckaufbewahrung', 'Luggage storage', 'Fundb√ºro', 'Lost and found',
          'Reisezentrum', 'Travel center', 'Vermietung', 'Rental',
          'Taxi', 'Bus', 'Tram', 'Anschluss', 'Connection'
        ];
        
        serviceKeywords.forEach(keyword => {
          if (document.body.textContent?.includes(keyword)) {
            results.servicesFound.push(keyword);
          }
        });
        
        // Accessibility information
        const accessibilityKeywords = [
          'Rollstuhl', 'Wheelchair', 'Barrierfrei', 'Accessible',
          'Behindert', 'Disabled', 'Mobilit√§ts', 'Mobility'
        ];
        results.accessibilityInfo = accessibilityKeywords.some(keyword => 
          document.body.textContent?.includes(keyword)
        );
        
        // Shopping options
        const shoppingKeywords = ['Shop', 'Gesch√§ft', 'Einkauf', 'Shopping', 'Laden'];
        results.shoppingOptions = shoppingKeywords.some(keyword => 
          document.body.textContent?.includes(keyword)
        );
        
        // Parking information
        const parkingKeywords = ['Parkplatz', 'Parking', 'Park+Rail', 'P+R'];
        results.parkingInfo = parkingKeywords.some(keyword => 
          document.body.textContent?.includes(keyword)
        );
        
        // WiFi information
        const wifiKeywords = ['WiFi', 'WLAN', 'Internet', 'free wifi'];
        results.wifiInfo = wifiKeywords.some(keyword => 
          document.body.textContent?.includes(keyword)
        );
        
        return results;
      });
      
      actions.logTestInfo('üè¢ Station facilities analysis:');
      if (facilitiesInfo.facilitiesFound.length > 0) {
        actions.logTestInfo(`  Facilities: ${facilitiesInfo.facilitiesFound.slice(0, 8).join(', ')}`);
      }
      if (facilitiesInfo.servicesFound.length > 0) {
        actions.logTestInfo(`  Services: ${facilitiesInfo.servicesFound.slice(0, 6).join(', ')}`);
      }
      actions.logTestInfo(`  Accessibility info: ${facilitiesInfo.accessibilityInfo ? '‚úÖ' : '‚ùå'}`);
      actions.logTestInfo(`  Shopping options: ${facilitiesInfo.shoppingOptions ? '‚úÖ' : '‚ùå'}`);
      actions.logTestInfo(`  Parking info: ${facilitiesInfo.parkingInfo ? '‚úÖ' : '‚ùå'}`);
      actions.logTestInfo(`  WiFi info: ${facilitiesInfo.wifiInfo ? '‚úÖ' : '‚ùå'}`);
      
      await actions.screenshot('station-facilities', 'Station facilities information');
    });

    await actions.step('‚ôø Test Accessibility Information', async () => {
      // Look specifically for accessibility features
      const accessibilityDetails = await page.evaluate(() => {
        const results = {
          wheelchairAccess: false,
          elevators: false,
          tactilePaving: false,
          audioAnnouncements: false,
          visualAids: false,
          assistanceServices: false,
          accessiblePlatforms: false
        };
        
        const bodyText = document.body.textContent || '';
        
        // Wheelchair accessibility
        const wheelchairKeywords = ['Rollstuhl', 'Wheelchair', 'rollstuhlg√§ngig', 'wheelchair accessible'];
        results.wheelchairAccess = wheelchairKeywords.some(keyword => 
          bodyText.toLowerCase().includes(keyword.toLowerCase())
        );
        
        // Elevators
        const elevatorKeywords = ['Aufzug', 'Elevator', 'Lift'];
        results.elevators = elevatorKeywords.some(keyword => 
          bodyText.includes(keyword)
        );
        
        // Tactile paving
        const tactileKeywords = ['Taktil', 'Tactile', 'Blindenleitsystem', 'F√ºhrungsstreifen'];
        results.tactilePaving = tactileKeywords.some(keyword => 
          bodyText.includes(keyword)
        );
        
        // Audio announcements
        const audioKeywords = ['Durchsage', 'Announcement', 'Audio', 'Lautsprecher'];
        results.audioAnnouncements = audioKeywords.some(keyword => 
          bodyText.includes(keyword)
        );
        
        // Visual aids
        const visualKeywords = ['Anzeige', 'Display', 'Monitor', 'Visual', 'Bildschirm'];
        results.visualAids = visualKeywords.some(keyword => 
          bodyText.includes(keyword)
        );
        
        // Assistance services
        const assistanceKeywords = ['Hilfe', 'Assistance', 'Support', 'Unterst√ºtzung'];
        results.assistanceServices = assistanceKeywords.some(keyword => 
          bodyText.includes(keyword)
        );
        
        // Accessible platforms
        const platformKeywords = ['Gleis', 'Platform', 'Bahnsteig', 'stufenlos'];
        results.accessiblePlatforms = platformKeywords.some(keyword => 
          bodyText.includes(keyword)
        );
        
        return results;
      });
      
      actions.logTestInfo('‚ôø Accessibility features analysis:');
      actions.logTestInfo(`  Wheelchair access: ${accessibilityDetails.wheelchairAccess ? '‚úÖ' : '‚ùå'}`);
      actions.logTestInfo(`  Elevators: ${accessibilityDetails.elevators ? '‚úÖ' : '‚ùå'}`);
      actions.logTestInfo(`  Tactile paving: ${accessibilityDetails.tactilePaving ? '‚úÖ' : '‚ùå'}`);
      actions.logTestInfo(`  Audio announcements: ${accessibilityDetails.audioAnnouncements ? '‚úÖ' : '‚ùå'}`);
      actions.logTestInfo(`  Visual aids: ${accessibilityDetails.visualAids ? '‚úÖ' : '‚ùå'}`);
      actions.logTestInfo(`  Assistance services: ${accessibilityDetails.assistanceServices ? '‚úÖ' : '‚ùå'}`);
      actions.logTestInfo(`  Accessible platforms: ${accessibilityDetails.accessiblePlatforms ? '‚úÖ' : '‚ùå'}`);
    });

    await actions.step('üÖøÔ∏è Test Parking and Transportation Links', async () => {
      // Look for parking and local transportation information
      const transportInfo = await page.evaluate(() => {
        const results = {
          parkAndRail: false,
          bikeParking: false,
          carParking: false,
          publicTransport: false,
          taxiInfo: false,
          busConnections: false,
          tramConnections: false,
          parkingPrices: [] as string[]
        };
        
        const bodyText = document.body.textContent || '';
        
        // Park and Rail
        const parkRailKeywords = ['Park+Rail', 'P+R', 'Park and Rail'];
        results.parkAndRail = parkRailKeywords.some(keyword => 
          bodyText.includes(keyword)
        );
        
        // Bike parking
        const bikeKeywords = ['Velo', 'Bike', 'Fahrrad', 'Bicycle'];
        results.bikeParking = bikeKeywords.some(keyword => 
          bodyText.includes(keyword)
        );
        
        // Car parking
        const carKeywords = ['Auto', 'Car', 'Parkplatz', 'Parking'];
        results.carParking = carKeywords.some(keyword => 
          bodyText.includes(keyword)
        );
        
        // Public transport
        const publicTransportKeywords = ['√ñV', 'Bus', 'Tram', '√∂ffentlich'];
        results.publicTransport = publicTransportKeywords.some(keyword => 
          bodyText.includes(keyword)
        );
        
        // Taxi
        const taxiKeywords = ['Taxi', 'Cab'];
        results.taxiInfo = taxiKeywords.some(keyword => 
          bodyText.includes(keyword)
        );
        
        // Bus connections
        const busKeywords = ['Bus', 'Busbahnhof', 'Buslinie'];
        results.busConnections = busKeywords.some(keyword => 
          bodyText.includes(keyword)
        );
        
        // Tram connections
        const tramKeywords = ['Tram', 'Stra√üenbahn', 'Linie'];
        results.tramConnections = tramKeywords.some(keyword => 
          bodyText.includes(keyword)
        );
        
        // Parking prices
        const pricePattern = /CHF\s*\d+\.?\d*|Preis.*CHF|Tarif.*CHF/g;
        const priceMatches = bodyText.match(pricePattern);
        if (priceMatches) {
          results.parkingPrices = priceMatches.slice(0, 3);
        }
        
        return results;
      });
      
      actions.logTestInfo('üÖøÔ∏è Transportation & parking analysis:');
      actions.logTestInfo(`  Park+Rail: ${transportInfo.parkAndRail ? '‚úÖ' : '‚ùå'}`);
      actions.logTestInfo(`  Bike parking: ${transportInfo.bikeParking ? '‚úÖ' : '‚ùå'}`);
      actions.logTestInfo(`  Car parking: ${transportInfo.carParking ? '‚úÖ' : '‚ùå'}`);
      actions.logTestInfo(`  Public transport: ${transportInfo.publicTransport ? '‚úÖ' : '‚ùå'}`);
      actions.logTestInfo(`  Taxi info: ${transportInfo.taxiInfo ? '‚úÖ' : '‚ùå'}`);
      actions.logTestInfo(`  Bus connections: ${transportInfo.busConnections ? '‚úÖ' : '‚ùå'}`);
      actions.logTestInfo(`  Tram connections: ${transportInfo.tramConnections ? '‚úÖ' : '‚ùå'}`);
      
      if (transportInfo.parkingPrices.length > 0) {
        actions.logTestInfo(`  Parking prices: ${transportInfo.parkingPrices.join(', ')}`);
      }
    });

    await actions.step('üõçÔ∏è Test Station Shopping and Dining', async () => {
      // Look for shopping and dining options
      const shoppingDining = await page.evaluate(() => {
        const results = {
          restaurants: [] as string[],
          cafes: [] as string[],
          shops: [] as string[],
          convenienceStores: false,
          bakeries: false,
          pharmacies: false,
          bookstores: false,
          openingHours: false
        };
        
        const bodyText = document.body.textContent || '';
        
        // Restaurants
        const restaurantKeywords = ['Restaurant', 'Gastronomie', 'Ristorante'];
        restaurantKeywords.forEach(keyword => {
          if (bodyText.includes(keyword)) {
            results.restaurants.push(keyword);
          }
        });
        
        // Cafes
        const cafeKeywords = ['Caf√©', 'Coffee', 'Kaffee', 'Starbucks', 'Espresso'];
        cafeKeywords.forEach(keyword => {
          if (bodyText.includes(keyword)) {
            results.cafes.push(keyword);
          }
        });
        
        // Shops
        const shopKeywords = ['Shop', 'Gesch√§ft', 'Laden', 'Store'];
        shopKeywords.forEach(keyword => {
          if (bodyText.includes(keyword)) {
            results.shops.push(keyword);
          }
        });
        
        // Convenience stores
        const convenienceKeywords = ['Convenience', 'Kiosk', 'Coop', 'Migros'];
        results.convenienceStores = convenienceKeywords.some(keyword => 
          bodyText.includes(keyword)
        );
        
        // Bakeries
        const bakeryKeywords = ['B√§ckerei', 'Bakery', 'Brot', 'Bread'];
        results.bakeries = bakeryKeywords.some(keyword => 
          bodyText.includes(keyword)
        );
        
        // Pharmacies
        const pharmacyKeywords = ['Apotheke', 'Pharmacy', 'Drogerie'];
        results.pharmacies = pharmacyKeywords.some(keyword => 
          bodyText.includes(keyword)
        );
        
        // Bookstores
        const bookKeywords = ['Buchhandlung', 'Bookstore', 'Buch', 'Book'];
        results.bookstores = bookKeywords.some(keyword => 
          bodyText.includes(keyword)
        );
        
        // Opening hours
        const hourKeywords = ['√ñffnungszeiten', 'Opening hours', 'ge√∂ffnet', 'open'];
        results.openingHours = hourKeywords.some(keyword => 
          bodyText.includes(keyword)
        );
        
        return results;
      });
      
      actions.logTestInfo('üõçÔ∏è Shopping & dining analysis:');
      if (shoppingDining.restaurants.length > 0) {
        actions.logTestInfo(`  Restaurants: ${shoppingDining.restaurants.join(', ')}`);
      }
      if (shoppingDining.cafes.length > 0) {
        actions.logTestInfo(`  Cafes: ${shoppingDining.cafes.join(', ')}`);
      }
      if (shoppingDining.shops.length > 0) {
        actions.logTestInfo(`  Shops: ${shoppingDining.shops.join(', ')}`);
      }
      actions.logTestInfo(`  Convenience stores: ${shoppingDining.convenienceStores ? '‚úÖ' : '‚ùå'}`);
      actions.logTestInfo(`  Bakeries: ${shoppingDining.bakeries ? '‚úÖ' : '‚ùå'}`);
      actions.logTestInfo(`  Pharmacies: ${shoppingDining.pharmacies ? '‚úÖ' : '‚ùå'}`);
      actions.logTestInfo(`  Bookstores: ${shoppingDining.bookstores ? '‚úÖ' : '‚ùå'}`);
      actions.logTestInfo(`  Opening hours: ${shoppingDining.openingHours ? '‚úÖ' : '‚ùå'}`);
      
      await actions.screenshot('station-shopping', 'Station shopping and dining options');
    });

    await actions.step('üìû Test Station Contact and Support', async () => {
      // Look for contact information and support services
      const contactInfo = await page.evaluate(() => {
        const results = {
          phoneNumbers: [] as string[],
          emailAddresses: [] as string[],
          informationDesk: false,
          customerService: false,
          emergencyInfo: false,
          lostAndFound: false,
          policeInfo: false
        };
        
        // Extract phone numbers
        const phonePattern = /(\+41|0041|0)\s*\d{2}\s*\d{3}\s*\d{2}\s*\d{2}/g;
        const phoneMatches = document.body.textContent?.match(phonePattern);
        if (phoneMatches) {
          results.phoneNumbers = [...new Set(phoneMatches)].slice(0, 3);
        }
        
        // Extract email addresses
        const emailPattern = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g;
        const emailMatches = document.body.textContent?.match(emailPattern);
        if (emailMatches) {
          results.emailAddresses = [...new Set(emailMatches)].slice(0, 3);
        }
        
        // Information desk
        const infoKeywords = ['Information', 'Auskunft', 'Schalter', 'Desk'];
        results.informationDesk = infoKeywords.some(keyword => 
          document.body.textContent?.includes(keyword)
        );
        
        // Customer service
        const serviceKeywords = ['Kundendienst', 'Customer service', 'Support', 'Kundenservice'];
        results.customerService = serviceKeywords.some(keyword => 
          document.body.textContent?.includes(keyword)
        );
        
        // Emergency information
        const emergencyKeywords = ['Notfall', 'Emergency', 'Hilfe', 'Help'];
        results.emergencyInfo = emergencyKeywords.some(keyword => 
          document.body.textContent?.includes(keyword)
        );
        
        // Lost and found
        const lostFoundKeywords = ['Fundb√ºro', 'Lost and found', 'Fundgegenst√§nde'];
        results.lostAndFound = lostFoundKeywords.some(keyword => 
          document.body.textContent?.includes(keyword)
        );
        
        // Police information
        const policeKeywords = ['Polizei', 'Police', 'Sicherheit', 'Security'];
        results.policeInfo = policeKeywords.some(keyword => 
          document.body.textContent?.includes(keyword)
        );
        
        return results;
      });
      
      actions.logTestInfo('üìû Contact & support analysis:');
      if (contactInfo.phoneNumbers.length > 0) {
        actions.logTestInfo(`  Phone numbers: ${contactInfo.phoneNumbers.join(', ')}`);
      }
      if (contactInfo.emailAddresses.length > 0) {
        actions.logTestInfo(`  Email addresses: ${contactInfo.emailAddresses.join(', ')}`);
      }
      actions.logTestInfo(`  Information desk: ${contactInfo.informationDesk ? '‚úÖ' : '‚ùå'}`);
      actions.logTestInfo(`  Customer service: ${contactInfo.customerService ? '‚úÖ' : '‚ùå'}`);
      actions.logTestInfo(`  Emergency info: ${contactInfo.emergencyInfo ? '‚úÖ' : '‚ùå'}`);
      actions.logTestInfo(`  Lost and found: ${contactInfo.lostAndFound ? '‚úÖ' : '‚ùå'}`);
      actions.logTestInfo(`  Police info: ${contactInfo.policeInfo ? '‚úÖ' : '‚ùå'}`);
    });

    await actions.step('üìã Station Information Summary', async () => {
      actions.logTestInfo('üìã Station Information Test Summary:');
      actions.logTestInfo('  üè¢ Station facilities and services overview');
      actions.logTestInfo('  ‚ôø Accessibility features and support');
      actions.logTestInfo('  üÖøÔ∏è Parking and transportation connections');
      actions.logTestInfo('  üõçÔ∏è Shopping and dining options');
      actions.logTestInfo('  üìû Contact information and support services');
      actions.logTestInfo('  üöâ Major station (Z√ºrich HB) detailed analysis');
      
      await actions.screenshot('station-summary', 'Complete station information overview');
    });
  });
});