# üöÄ Mobile Testing Setup Script f√ºr Windows
# Installiert alle notwendigen Tools f√ºr Android Testing (Real Device + Emulator)

Write-Host "üèÅ Starting Mobile Testing Setup..." -ForegroundColor Green
Write-Host "üì± Target: Pixel 8a + Android Emulator" -ForegroundColor Cyan

# Check if running as administrator
$isAdmin = ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")

if (-not $isAdmin) {
    Write-Host "‚ö†Ô∏è  This script requires Administrator privileges for some installations." -ForegroundColor Yellow
    Write-Host "üí° Please run PowerShell as Administrator for full functionality." -ForegroundColor Yellow
}

# Function to check if a command exists
function Test-Command($command) {
    try {
        Get-Command $command -ErrorAction Stop
        return $true
    } catch {
        return $false
    }
}

# Function to download and install from URL
function Install-FromUrl($name, $url, $installer) {
    Write-Host "üì• Downloading $name..." -ForegroundColor Yellow
    $tempPath = "$env:TEMP\$installer"
    try {
        Invoke-WebRequest -Uri $url -OutFile $tempPath -UseBasicParsing
        Write-Host "üöÄ Installing $name..." -ForegroundColor Green
        Start-Process $tempPath -Wait
        Remove-Item $tempPath -Force
        Write-Host "‚úÖ $name installed successfully" -ForegroundColor Green
    } catch {
        Write-Host "‚ùå Failed to install $name : $_" -ForegroundColor Red
    }
}

Write-Host "`nüîç Step 1: Checking existing installations..." -ForegroundColor Magenta

# Check Node.js
if (Test-Command "node") {
    $nodeVersion = node --version
    Write-Host "‚úÖ Node.js found: $nodeVersion" -ForegroundColor Green
} else {
    Write-Host "‚ùå Node.js not found. Please install Node.js 20.x LTS from https://nodejs.org" -ForegroundColor Red
    Write-Host "üìã Manual installation required for Node.js" -ForegroundColor Yellow
}

# Check Java
if (Test-Command "java") {
    $javaVersion = java -version 2>&1 | Select-String "version"
    Write-Host "‚úÖ Java found: $javaVersion" -ForegroundColor Green
} else {
    Write-Host "‚ùå Java not found. Installing OpenJDK 17..." -ForegroundColor Yellow
    if ($isAdmin) {
        try {
            # Try to install via winget
            winget install Microsoft.OpenJDK.17
            Write-Host "‚úÖ OpenJDK 17 installed via winget" -ForegroundColor Green
        } catch {
            Write-Host "‚ö†Ô∏è  Please install Java 17 manually from: https://learn.microsoft.com/en-us/java/openjdk/download" -ForegroundColor Yellow
        }
    } else {
        Write-Host "üìã Manual installation required: https://learn.microsoft.com/en-us/java/openjdk/download" -ForegroundColor Yellow
    }
}

Write-Host "`nü§ñ Step 2: Android SDK Setup..." -ForegroundColor Magenta

# Check if Android Studio or SDK tools are installed
$androidSdkPaths = @(
    "$env:LOCALAPPDATA\Android\Sdk",
    "$env:ProgramFiles\Android\Android Studio\sdk",
    "${env:ProgramFiles(x86)}\Android\android-sdk"
)

$androidSdkPath = $null
foreach ($path in $androidSdkPaths) {
    if (Test-Path $path) {
        $androidSdkPath = $path
        break
    }
}

if ($androidSdkPath) {
    Write-Host "‚úÖ Android SDK found at: $androidSdkPath" -ForegroundColor Green
    
    # Set environment variables
    [Environment]::SetEnvironmentVariable("ANDROID_HOME", $androidSdkPath, "User")
    [Environment]::SetEnvironmentVariable("ANDROID_SDK_ROOT", $androidSdkPath, "User")
    
    # Add to PATH
    $currentPath = [Environment]::GetEnvironmentVariable("PATH", "User")
    $platformTools = "$androidSdkPath\platform-tools"
    $tools = "$androidSdkPath\tools"
    $toolsBin = "$androidSdkPath\tools\bin"
    
    if ($currentPath -notlike "*$platformTools*") {
        [Environment]::SetEnvironmentVariable("PATH", "$currentPath;$platformTools;$tools;$toolsBin", "User")
        Write-Host "‚úÖ Android tools added to PATH" -ForegroundColor Green
    }
    
    # Refresh environment variables for current session
    $env:ANDROID_HOME = $androidSdkPath
    $env:ANDROID_SDK_ROOT = $androidSdkPath
    $env:PATH = "$env:PATH;$platformTools;$tools;$toolsBin"
    
} else {
    Write-Host "‚ùå Android SDK not found. Installing Android Studio..." -ForegroundColor Yellow
    
    if ($isAdmin) {
        try {
            winget install Google.AndroidStudio
            Write-Host "‚úÖ Android Studio installation initiated" -ForegroundColor Green
            Write-Host "üîÑ Please complete Android Studio setup and install SDK components" -ForegroundColor Yellow
        } catch {
            Write-Host "üìã Manual installation required: https://developer.android.com/studio" -ForegroundColor Yellow
        }
    } else {
        Write-Host "üìã Manual installation required: https://developer.android.com/studio" -ForegroundColor Yellow
    }
}

Write-Host "`nüì± Step 3: Device Connection Test..." -ForegroundColor Magenta

# Test ADB (after environment setup)
try {
    $adbPath = "$androidSdkPath\platform-tools\adb.exe"
    if (Test-Path $adbPath) {
        Write-Host "üîß Testing ADB connection..." -ForegroundColor Yellow
        $devices = & $adbPath devices
        Write-Host "üì± Connected devices:" -ForegroundColor Cyan
        Write-Host $devices -ForegroundColor Gray
        
        if ($devices -match "device$") {
            Write-Host "‚úÖ Real device detected and ready!" -ForegroundColor Green
        } else {
            Write-Host "‚ö†Ô∏è  No devices detected. Please:" -ForegroundColor Yellow
            Write-Host "   1. Connect your Pixel 8a via USB" -ForegroundColor Gray
            Write-Host "   2. Enable Developer Options" -ForegroundColor Gray
            Write-Host "   3. Enable USB Debugging" -ForegroundColor Gray
            Write-Host "   4. Authorize RSA key on device" -ForegroundColor Gray
        }
    }
} catch {
    Write-Host "‚ö†Ô∏è  ADB not yet available. Please restart PowerShell after Android SDK installation." -ForegroundColor Yellow
}

Write-Host "`nüéØ Step 4: Appium Setup Verification..." -ForegroundColor Magenta

if (Test-Command "appium") {
    $appiumVersion = appium --version
    Write-Host "‚úÖ Appium found: v$appiumVersion" -ForegroundColor Green
    
    # Check drivers
    Write-Host "üîç Checking Appium drivers..." -ForegroundColor Yellow
    $drivers = appium driver list --installed 2>&1
    Write-Host $drivers -ForegroundColor Gray
    
    if ($drivers -match "uiautomator2") {
        Write-Host "‚úÖ UiAutomator2 driver ready" -ForegroundColor Green
    } else {
        Write-Host "üîß Installing UiAutomator2 driver..." -ForegroundColor Yellow
        appium driver install uiautomator2
    }
} else {
    Write-Host "‚ùå Appium not found. Installing..." -ForegroundColor Red
    npm install -g appium
    appium driver install uiautomator2
}

Write-Host "`nüéÆ Step 5: Emulator Setup..." -ForegroundColor Magenta

if ($androidSdkPath) {
    $avdManagerPath = "$androidSdkPath\cmdline-tools\latest\bin\avdmanager.bat"
    $emulatorPath = "$androidSdkPath\emulator\emulator.exe"
    
    if (Test-Path $avdManagerPath) {
        Write-Host "üîß Setting up Android emulator..." -ForegroundColor Yellow
        
        # List available system images
        Write-Host "üìã Available system images:" -ForegroundColor Cyan
        & $avdManagerPath list target
        
        # Create a test AVD if none exists
        $avdList = & $avdManagerPath list avd
        if ($avdList -notmatch "pixel_8a_test") {
            Write-Host "üéØ Creating Pixel 8a test emulator..." -ForegroundColor Yellow
            # Note: This requires system image to be downloaded first
            Write-Host "üìù To create emulator manually:" -ForegroundColor Cyan
            Write-Host "   1. Open Android Studio" -ForegroundColor Gray
            Write-Host "   2. Go to AVD Manager" -ForegroundColor Gray
            Write-Host "   3. Create Virtual Device -> Pixel 8a" -ForegroundColor Gray
            Write-Host "   4. Choose Android 14 (API 34) system image" -ForegroundColor Gray
        }
    } else {
        Write-Host "‚ö†Ô∏è  AVD Manager not found. Please install Android SDK command-line tools." -ForegroundColor Yellow
    }
}

Write-Host "`nüîß Step 6: Project Configuration..." -ForegroundColor Magenta

# Check if we can detect Geberit app
if ($androidSdkPath -and (Test-Path "$androidSdkPath\platform-tools\adb.exe")) {
    Write-Host "üîç Searching for Geberit Home app..." -ForegroundColor Yellow
    try {
        $adbPath = "$androidSdkPath\platform-tools\adb.exe"
        $packages = & $adbPath shell pm list packages | Select-String "geberit"
        
        if ($packages) {
            Write-Host "‚úÖ Geberit app found:" -ForegroundColor Green
            Write-Host $packages -ForegroundColor Gray
            
            # Try to get activity
            Write-Host "üéØ Detecting main activity..." -ForegroundColor Yellow
            $activity = & $adbPath shell "cmd package resolve-activity --brief com.geberit.home" 2>&1 | Select-Object -Last 1
            if ($activity -and $activity -ne "") {
                Write-Host "‚úÖ Main activity detected: $activity" -ForegroundColor Green
                Write-Host "üìù Update config/wdio.local.android.ts with:" -ForegroundColor Cyan
                $activityShort = $activity -replace "com\.geberit\.home", ""
                Write-Host "   appium:appActivity: $activityShort" -ForegroundColor Gray
            }
        } else {
            Write-Host "‚ö†Ô∏è  Geberit Home app not found. Please install from Play Store." -ForegroundColor Yellow
        }
    } catch {
        Write-Host "‚ö†Ô∏è  Could not check for Geberit app. Device may not be connected." -ForegroundColor Yellow
    }
}

Write-Host "`nüéâ Setup Summary:" -ForegroundColor Green
Write-Host "===================" -ForegroundColor Green
Write-Host "‚úÖ Mobile testing framework created" -ForegroundColor White
Write-Host "‚úÖ Node.js dependencies installed" -ForegroundColor White
Write-Host "‚úÖ Appium and UiAutomator2 ready" -ForegroundColor White

if ($androidSdkPath) {
    Write-Host "‚úÖ Android SDK configured" -ForegroundColor White
} else {
    Write-Host "‚ö†Ô∏è  Android SDK needs manual installation" -ForegroundColor Yellow
}

Write-Host "`nüöÄ Next Steps:" -ForegroundColor Cyan
Write-Host "1. Restart PowerShell to refresh environment variables" -ForegroundColor White
Write-Host "2. Connect Pixel 8a and authorize USB debugging" -ForegroundColor White
Write-Host "3. Update activity in config/wdio.local.android.ts" -ForegroundColor White
Write-Host "4. Run: npm run dev" -ForegroundColor White

Write-Host "`nüìö For emulator testing:" -ForegroundColor Cyan
Write-Host "1. Open Android Studio -> AVD Manager" -ForegroundColor White
Write-Host "2. Create Pixel 8a emulator with Android 14" -ForegroundColor White
Write-Host "3. Install Geberit Home app in emulator" -ForegroundColor White

Write-Host "`nüîß Troubleshooting:" -ForegroundColor Magenta
Write-Host "- If ADB not found: Restart PowerShell" -ForegroundColor White
Write-Host "- If device unauthorized: Check USB debugging dialog" -ForegroundColor White
Write-Host "- If Java errors: Install OpenJDK 17" -ForegroundColor White
Write-Host "- For detailed help: See mobile/README.md" -ForegroundColor White

Write-Host "`n‚ú® Setup completed! Happy testing! üß™" -ForegroundColor Green